<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>License</title>
    <style>
        :root {
            --top-h: 56px;
            --side-w: 240px;
            --bg: #f6f7fb;
            --card: #fff;
            --muted: #6b7280;
            --border: #e5e7eb;
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            background: var(--bg);
            display: grid;
            grid-template-rows: var(--top-h) 1fr;
            grid-template-columns: var(--side-w) 1fr;
            grid-template-areas:
        "top top"
        "side main";
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        }

        /* Topbar */
        .topbar {
            grid-area: top;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .brand { font-weight: 700; font-size: 16px; letter-spacing: .2px; }
        .right { display: flex; align-items: center; gap: 12px; position: relative; }
        .btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 12px; border-radius: 10px;
            border: 1px solid var(--border); background: #fff; cursor: pointer; font-weight: 600;
        }
        .btn.primary { background: #2b63f1; color: #fff; border-color: #2b63f1; }

        /* Avatar + dropdown */
        .avatar-btn {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            padding: 6px 8px; border-radius: 12px; border: 1px solid var(--border); background: #fff;
        }
        .avatar {
            width: 28px; height: 28px; border-radius: 50%; display: grid; place-items: center;
            font-size: 12px; font-weight: 700; background: #e5e7eb; color: #111827; overflow: hidden;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .user-label { font-size: 14px; color: #111827; font-weight: 600; }
        .dropdown {
            position: absolute; top: 46px; right: 0; width: 220px; background: #fff;
            border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,.08);
            display: none; overflow: hidden;
        }
        .dropdown.open { display: block; }
        .dd-item { padding: 10px 12px; font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .dd-item:hover { background: #f3f4f6; }
        .dd-sep { height: 1px; background: var(--border); margin: 4px 0; }

        /* Sidebar */
        .sidebar {
            grid-area: side; background: #fff; border-right: 1px solid var(--border);
            padding: 12px; display: flex; flex-direction: column; gap: 6px;
        }
        .nav-title {
            font-size: 12px; color: var(--muted); padding: 8px 10px; text-transform: uppercase; letter-spacing: .6px;
        }

        /* Grouped menu */
        .menu, .submenu { list-style: none; margin: 0; padding: 0; }
        .group {
            border: 1px solid var(--border);
            border-radius: 12px; margin-bottom: 8px; overflow: hidden; background: #fff;
        }
        .menu-toggle {
            width: 100%; text-align: left; padding: 10px 12px; font-weight: 700;
            background: #fff; border: 0; color: #111827; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between;
        }
        .menu-toggle span { font-size: 13px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .6px; }
        .menu-toggle::after { content: "▸"; transition: transform .2s ease; font-size: 12px; opacity: .8; }
        .group.open .menu-toggle::after { transform: rotate(90deg); }

        .submenu { display: none; padding: 6px 0 10px 0; background: #fff; }
        .group.open .submenu { display: block; }
        .submenu li { margin: 2px 0; }
        .submenu a {
            display: block; padding: 8px 14px; border-left: 2px solid transparent;
            color: #111827; text-decoration: none; border-radius: 8px; margin: 2px 8px;
        }
        .submenu a:hover { background: #f3f4f6; }
        .submenu a.active { background: #e9f0ff; border-left-color: #4f8cff; font-weight: 600; }
        .menu > li.single a{
  display:block; padding:8px 14px; border-left:2px solid transparent;
  color:#111827; text-decoration:none; border-radius:8px; margin:2px 8px;
}
.menu > li.single a:hover{ background:#f3f4f6; }
.menu > li.single a.active{ background:#e9f0ff; border-left-color:#4f8cff; font-weight:600; }


        /* Main */
        .main { grid-area: main; padding: 16px; }
        .card {
            background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,.04);
        }
        .muted { color: var(--muted); }



        @media (max-width: 900px) { :root { --side-w: 200px; } }
        @media (max-width: 720px) {
            body {
                grid-template-columns: 1fr;
                grid-template-areas: "top" "main";
            }
            .sidebar { display: none; }
        }
    </style>
</head>

<body>
<!-- Top Navbar -->
<header class="topbar">
    <div class="brand" id="pageTitle">License</div>
    <div class="right" id="topRight">
        <!-- if NOT logged in -->
        <button id="btnLogin" class="btn primary" style="display:none">Đăng nhập</button>

        <!-- if logged in -->
        <div id="userMenu" class="avatar-btn" style="display:none">
            <div class="avatar" id="avatarBox" aria-hidden="true"></div>
            <div class="user-label" id="userLabel">Tài khoản</div>
        </div>
        <div id="dropdown" class="dropdown" role="menu" aria-hidden="true">
            <div class="dd-item" id="ddProfile">Thông tin người dùng</div>
            <div class="dd-sep"></div>
            <div class="dd-item" id="ddLogout">Đăng xuất</div>
        </div>
    </div>
</header>


<!-- Left Sidebar -->
<aside class="sidebar">
    <div class="nav-title">Điều hướng</div>
    <nav aria-label="Điều hướng">
        <ul class="menu">

            <li class="single"><a href="/index.html">Trang chủ</a></li>

            <!-- Mua hàng -->
            <li class="group">
                <button class="menu-toggle" aria-expanded="false">
                    <span>Mua hàng</span>
                </button>
                <ul class="submenu">
                    <li><a href="/products.html">Sản phẩm</a></li>
                    <li><a href="/plans.html">Gói / Plans</a></li>
                </ul>
            </li>

            <!-- Đơn hàng -->
            <li class="group">
                <button class="menu-toggle" aria-expanded="false">
                    <span>Đơn hàng</span>
                </button>
                <ul class="submenu">
                    <li><a href="/orders.html">Tất cả đơn hàng</a></li>
                    <!-- <li><a href="/orders-new.html">Tạo đơn</a></li> -->
                </ul>
            </li>

            <!-- License -->
            <li class="group">
                <button class="menu-toggle" aria-expanded="false">
                    <span>License</span>
                </button>
                <ul class="submenu">
                    <li><a href="/licenses.html">Danh sách License</a></li>
                    <!-- <li><a href="/accounts.html">Tài khoản con</a></li>
                    <li><a href="/sessions.html">Phiên hoạt động</a></li> -->
                </ul>
            </li>

            <!-- Tài khoản -->
            <li class="group">
                <button class="menu-toggle" aria-expanded="false">
                    <span>Tài khoản</span>
                </button>
                <ul class="submenu">
                    <li><a href="/profile.html">Hồ sơ</a></li>
                    <!-- <li><a href="/wallet.html">Ví</a></li>
                    <li><a href="/wallet-txns.html">Giao dịch ví</a></li> -->
                </ul>
            </li>

            <!-- Tài liệu -->
            <li class="group">
                <button class="menu-toggle" aria-expanded="false">
                    <span>Tài liệu</span>
                </button>
                <ul class="submenu">
                    <li><a href="/docs.html">Tài liệu</a></li>
                    <!-- <li><a href="/docs-api.html">API Docs</a></li> -->
                </ul>
            </li>

        </ul>
    </nav>
</aside>

<!-- Main content -->
<main class="main">
    <div class="card">
        <h2>Chào mừng!</h2>
        <p class="muted">
            Đây là trang tổng quan. Dùng menu bên trái để chuyển trang.
            Navbar trên cùng sẽ hiện “Đăng nhập” khi chưa có phiên, hoặc avatar + menu khi đã đăng nhập.
        </p>
        <div id="debug" class="muted" style="margin-top:8px; font-size:12px;"></div>
    </div>
</main>

<script>
    // ====== CONFIG ======
    const API_BASE = "http://localhost:8080"; // đổi nếu FE/BE khác origin
    const PROFILE_ENDPOINTS = ["/api/auth/me", "/api/users/me", "/api/me", "/api/profile"];

    // ====== DOM ======
    const btnLogin = document.getElementById('btnLogin');
    const userMenu = document.getElementById('userMenu');
    const dropdown = document.getElementById('dropdown');
    const ddProfile = document.getElementById('ddProfile');
    const ddLogout = document.getElementById('ddLogout');
    const avatarBox = document.getElementById('avatarBox');
    const userLabel = document.getElementById('userLabel');
    const debugEl = document.getElementById('debug');

    // ====== Sidebar toggle & active ======
    document.querySelectorAll('.menu-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
            const li = btn.closest('.group');
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', String(!expanded));
            li.classList.toggle('open', !expanded);
        });
    });

    (function markActive() {
        const path = location.pathname.replace(/\/+$/, '') || '/';
        const links = document.querySelectorAll('.submenu a[href]');
        links.forEach(a => {
            const href = a.getAttribute('href');
            if (!href) return;
            const normalized = href.replace(/\/+$/, '') || '/';
            if (normalized === path || (normalized !== '/' && path.endsWith(normalized))) {
                a.classList.add('active');
                const group = a.closest('.group');
                if (group) {
                    group.classList.add('open');
                    const toggle = group.querySelector('.menu-toggle');
                    if (toggle) toggle.setAttribute('aria-expanded', 'true');
                }
            }
        });
    })();

    // ====== Auth helpers ======
    function getAccess() {
        const token = localStorage.getItem('accessToken');
        const type = localStorage.getItem('tokenType') || 'Bearer';
        return token ? { header: `${type} ${token}`, token } : null;
    }
    async function apiGet(url) {
        const access = getAccess();
        const headers = access ? { 'Authorization': access.header } : {};
        const r = await fetch(API_BASE + url, { headers });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        return r.json().catch(() => ({}));
    }
    async function tryGetProfile() {
        for (const ep of PROFILE_ENDPOINTS) {
            try {
                const data = await apiGet(ep);
                const mapped = mapProfile(data);
                if (mapped) return mapped;
            } catch (_) {}
        }
        return null;
    }
    function mapProfile(data) {
        if (!data || typeof data !== 'object') return null;
        const name = data.name || data.fullName || data.username || data.displayName || data.email || null;
        const email = data.email || data.mail || null;
        const avatarUrl = data.avatarUrl || data.avatar || null;
        if (!name && !email && !avatarUrl) return null;
        return { name, email, avatarUrl };
    }
    function initialsFrom(text) {
        if (!text) return "U";
        const parts = String(text).trim().split(/\s+/);
        if (parts.length === 1) return parts[0].slice(0, 2).toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    function setAvatar({name, email, avatarUrl} = {}) {
        avatarBox.innerHTML = "";
        if (avatarUrl) {
            const img = document.createElement('img');
            img.src = avatarUrl; img.alt = name || email || "avatar";
            avatarBox.appendChild(img);
        } else {
            avatarBox.textContent = initialsFrom(name || email || "U");
        }
        userLabel.textContent = name || email || "Tài khoản";
    }
    function showLoggedOut() {
        btnLogin.style.display = "inline-flex";
        userMenu.style.display = "none";
        dropdown.classList.remove('open');
    }
    function showLoggedIn(profile) {
        btnLogin.style.display = "none";
        userMenu.style.display = "flex";
        setAvatar(profile || {});
    }
    function logout() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('tokenType');
        localStorage.removeItem('accessExpAt');
        window.location.href = '/login.html';
    }

    // ====== Topbar events ======
    btnLogin.addEventListener('click', () => { window.location.href = '/login.html'; });
    userMenu.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('open');
        dropdown.setAttribute('aria-hidden', dropdown.classList.contains('open') ? 'false' : 'true');
    });
    document.addEventListener('click', () => dropdown.classList.remove('open'));
    ddProfile.addEventListener('click', () => { window.location.href = '/profile.html'; });
    ddLogout.addEventListener('click', logout);

    // ====== Init ======
    (async function init() {
        const access = getAccess();
        if (!access) { showLoggedOut(); return; }
        try {
            const profile = await tryGetProfile();
            showLoggedIn(profile);
            debugEl.textContent = "";
        } catch (e) {
            showLoggedOut();
            debugEl.textContent = "Không lấy được hồ sơ người dùng (có thể token hết hạn).";
        }
    })();
</script>
</body>
</html>
