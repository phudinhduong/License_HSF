<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Đăng nhập</title>
    <style>
        :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
        * { box-sizing: border-box; }
        body {
            min-height: 100dvh; margin: 0; display: grid; place-items: center;
            background: #f6f7fb;
        }
        .card {
            width: 100%; max-width: 420px; background: #fff; padding: 24px 24px 16px;
            border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.06);
        }
        h1 { margin: 0 0 8px; font-size: 22px; }
        p.sub { margin: 0 0 20px; color: #666; font-size: 14px; }
        label { display: block; font-weight: 600; margin: 12px 0 6px; font-size: 14px; }
        input[type="email"], input[type="password"] {
            width: 100%; padding: 12px 14px; border: 1px solid #dcdfe6; border-radius: 10px; font-size: 14px;
            outline: none; transition: border .15s;
        }
        input:focus { border-color: #5b8def; }
        .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; margin-top: 10px; }
        .checkbox { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #444; }
        .actions { margin-top: 16px; display: grid; gap: 10px; }
        button {
            border: none; padding: 12px 16px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 14px;
            background: #2b63f1; color: white; transition: opacity .15s, transform .02s;
        }
        button:disabled { opacity: .6; cursor: not-allowed; }
        button:active { transform: translateY(1px); }
        .msg { margin-top: 12px; font-size: 13px; padding: 10px 12px; border-radius: 10px; display: none; }
        .msg.ok { background: #eef9f0; color: #256c3c; display: block; }
        .msg.err { background: #ffeeee; color: #9b2c2c; display: block; }
        .muted { color: #888; font-size: 12px; margin-top: 8px; text-align: center; }
        .toggle-eye { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 12px; color: #666; }
        .field { position: relative; }
    </style>
</head>
<body>
<div class="card">
    <h1>Đăng nhập</h1>
    <p class="sub">Nhập email và mật khẩu để lấy JWT (access/refresh).</p>

    <form id="loginForm" novalidate>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" autocomplete="username" required />

        <label for="password">Mật khẩu</label>
        <div class="field">
            <input id="password" name="password" type="password" placeholder="••••••••" autocomplete="current-password" required />
            <span id="toggleEye" class="toggle-eye" title="Hiện/ẩn">Hiện</span>
        </div>

        <div class="row">
            <label class="checkbox"><input id="remember" type="checkbox" /> Ghi nhớ email</label>
            <a href="#" style="font-size:13px; color:#2b63f1; text-decoration:none">Quên mật khẩu?</a>
        </div>

        <div class="actions">
            <button id="btnLogin" type="submit">Đăng nhập</button>
            <div id="msg" class="msg"></div>
        </div>
    </form>

    <p class="muted">Tip: Sau khi đăng nhập thành công, token được lưu vào <code>localStorage</code>.</p>
</div>

<script>
    // Nếu backend cùng origin (http://localhost:8080) giữ rỗng; nếu khác, điền base URL vào đây
    const API_BASE = "http://localhost:8081"; // ví dụ: "http://localhost:8080"

    const form = document.getElementById('loginForm');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const rememberEl = document.getElementById('remember');
    const btn = document.getElementById('btnLogin');
    const msg = document.getElementById('msg');
    const toggleEye = document.getElementById('toggleEye');

    // Khôi phục email nếu đã "ghi nhớ"
    (function restoreRemembered() {
        const remembered = localStorage.getItem('rememberedEmail');
        if (remembered) {
            emailEl.value = remembered;
            rememberEl.checked = true;
        }
    })();

    // Toggle hiện/ẩn mật khẩu
    toggleEye.addEventListener('click', () => {
        const isPwd = passEl.type === 'password';
        passEl.type = isPwd ? 'text' : 'password';
        toggleEye.textContent = isPwd ? 'Ẩn' : 'Hiện';
    });

    function setMessage(type, text) {
        msg.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
        msg.textContent = text;
        msg.style.display = 'block';
    }
    function clearMessage() {
        msg.className = 'msg';
        msg.style.display = 'none';
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMessage();

        const email = emailEl.value.trim();
        const password = passEl.value;

        if (!email || !password) {
            setMessage('err', 'Vui lòng nhập đầy đủ email và mật khẩu.');
            return;
        }

        // Lưu/clear email đã nhớ
        if (rememberEl.checked) {
            localStorage.setItem('rememberedEmail', email);
        } else {
            localStorage.removeItem('rememberedEmail');
        }

        btn.disabled = true;
        btn.textContent = 'Đang đăng nhập...';

        try {
            const resp = await fetch(API_BASE + '/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            // Thử đọc response body (text trước -> JSON sau để dễ lấy message khi lỗi)
            const raw = await resp.text();
            const data = raw ? safeJson(raw) : null;

            if (!resp.ok) {
                const reason = (data && (data.message || data.error || data.detail)) || raw || 'Đăng nhập thất bại.';
                throw new Error(reason);
            }

            // Hỗ trợ cả hai dạng cũ ({access, refresh}) và mới ({accessToken, refreshToken, expiresIn, tokenType})
            const access  = data?.access  ?? data?.accessToken;
            const refresh = data?.refresh ?? data?.refreshToken;
            const tokenType = data?.tokenType || 'Bearer';
            const expiresIn = Number(data?.expiresIn) || null;

            if (!access || !refresh) {
                throw new Error('Phản hồi đăng nhập không hợp lệ: thiếu accessToken/refreshToken.');
            }

// Lưu token + metadata
            localStorage.setItem('accessToken', access);
            localStorage.setItem('refreshToken', refresh);
            localStorage.setItem('tokenType', tokenType);

// Lưu thời điểm hết hạn (nếu server trả về)
            if (expiresIn) {
                const expAt = Date.now() + expiresIn * 1000; // ms
                localStorage.setItem('accessExpAt', String(expAt));
            }

            setMessage('ok', 'Đăng nhập thành công! Đang chuyển hướng...');

            // Ví dụ: chuyển hướng về trang chủ hoặc dashboard
            setTimeout(() => {
                window.location.href = '/';
            }, 700);
        } catch (err) {
            setMessage('err', err.message || 'Có lỗi xảy ra.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Đăng nhập';
        }
    });

    function safeJson(t) {
        try { return JSON.parse(t); } catch { return null; }
    }

    // ——— Ví dụ: hàm call API kèm Authorization Bearer (dùng trong các trang khác) ———
    window.apiGet = async function apiGet(url) {
        const access = localStorage.getItem('accessToken');
        const r = await fetch((API_BASE + url), {
            headers: { 'Authorization': access ? 'Bearer ' + access : '' }
        });
        if (r.status === 401) {
            // Có thể tự động refresh ở đây nếu muốn
        }
        return r.json();
    };
</script>
</body>
</html>
